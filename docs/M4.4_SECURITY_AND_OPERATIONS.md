# M4.4 – Security, Audit, Rate Limits, Backup, Monitoring

**Owner:** Jordan. **Status:** Implemented.

---

## 1. Security (auth, secrets)

- **API key (optional):** If `TGND_API_KEY` or `API_KEY` is set in env, all routes except `/health` and `/ready` require `X-API-Key: <key>` or `Authorization: Bearer <key>`. If not set, API is open (dev mode).
- **Secrets:** All secrets (DB URL, API keys, provider keys) MUST live in `.env` or environment; never committed. `.gitignore` includes `.env`, `.env.*`, `secrets/`.

---

## 2. Audit log

- **Table:** `audit_log` (migration `db/migrations/00004_audit_log.sql`). Columns: `at`, `action`, `resource`, `resource_id`, `actor`, `details` (JSONB), `request_id`.
- **Logged actions:** `work_order.create`, `work_order.patch`, `work_order.assign` (from API routes). Webhooks can be added similarly via `recordAudit(req, { action, resource, resource_id, details })` from `middleware/audit.js`.
- **Run migration:** `cd apps/api && npm run migrate` (or `node scripts/run-migration.js`) so `audit_log` exists.

---

## 3. Rate limits

- **In-memory per IP:** `RATE_LIMIT_WINDOW_MS` (default 60000), `RATE_LIMIT_MAX` (default 100) requests per window. Response headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`. 429 when exceeded.

---

## 4. Backup

- **Script:** `scripts/backup-db.sh [output_dir]`. Uses `DATABASE_URL` from env; writes `output_dir/tgnd_db_YYYYMMDD_HHMMSS.sql`. Optionally tarballs `config/`.
- **Strategy:** Run via cron or scheduler (e.g. daily); retain N copies; store off-host. DB backup is pg_dump; config backup excludes secrets.

---

## 5. Monitoring

- **Health (liveness):** `GET /health` → `{ status: 'ok', service: 'api' }`.
- **Readiness (DB):** `GET /ready` → 200 and `{ db: 'connected' }` if DB ping succeeds; 503 and `{ db: 'disconnected' }` otherwise.
- **Error rate / logs:** Use existing `@tgnd/logger` (JSON to stdout). For production, ship logs to your aggregator (e.g. CloudWatch, Datadog, file-based rotation).

---

*Operate: set `TGND_API_KEY` in production; run migration; schedule backup-db.sh; point health checks at `/health` and `/ready`.*
